services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: tms-temp
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-979712}
      POSTGRES_DB: ${POSTGRES_DB:-tms}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      # Initialize database với schema và seed data
      - ./tms-be-temp/src/main/resources/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./tms-be-temp/src/main/resources/seed-data.sql:/docker-entrypoint-initdb.d/02-seed-data.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d tms"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - tms-network
    restart: unless-stopped

  # Combined Frontend + Backend Application
  app:
    build:
      context: ..
      dockerfile: tms-be-temp/Dockerfile
    container_name: tms-app
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - tms-be-temp/.env
    environment:
      # Database connection
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/tms
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 979712
      # JWT secret
      JWT_SECRET: ${JWT_SECRET:-ThisIsAVerySecretKeyForJWTTokenGenerationPleaseChangeInProduction123456789}
      # Spring profile
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      # JVM options
      JAVA_OPTS: "${JAVA_OPTS:--Xmx1024m -Xms512m -XX:+UseG1GC}"
      # AWS S3 Configuration
      AWS_S3_BUCKET: ${AWS_S3_BUCKET}
      AWS_S3_ACCESS_KEY: ${AWS_S3_ACCESS_KEY}
      AWS_S3_SECRET_KEY: ${AWS_S3_SECRET_KEY}
    ports:
      - "${FRONTEND_PORT:-80}:80" # Frontend (nginx)
      - "${BACKEND_PORT:-8080}:8080" # Backend API (optional, có thể bỏ)
    networks:
      - tms-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  tms-network:
    driver: bridge
